name: Update Cask

on:
  repository_dispatch:
    types: [update-cask]

jobs:
  update:
    name: Update oh-my-query cask
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Extract payload
        id: payload
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "aarch64_sha=${{ github.event.client_payload.aarch64_sha }}" >> $GITHUB_OUTPUT
          echo "x64_sha=${{ github.event.client_payload.x64_sha }}" >> $GITHUB_OUTPUT

      - name: Update cask version and hashes
        env:
          VERSION: ${{ steps.payload.outputs.version }}
          AARCH64_SHA: ${{ steps.payload.outputs.aarch64_sha }}
          X64_SHA: ${{ steps.payload.outputs.x64_sha }}
        run: |
          python3 - <<'PYEOF'
          import re, os

          cask_path = "Casks/oh-my-query.rb"
          version = os.environ["VERSION"]
          aarch64_sha = os.environ["AARCH64_SHA"]
          x64_sha = os.environ["X64_SHA"]

          with open(cask_path, "r") as f:
              content = f.read()

          content = re.sub(r'version "[^"]*"', f'version "{version}"', content)

          content = re.sub(
              r'(on_arm do\n.*\n\s+sha256 ")[^"]*(")',
              rf'\g<1>{aarch64_sha}\g<2>',
              content
          )

          content = re.sub(
              r'(on_intel do\n.*\n\s+sha256 ")[^"]*(")',
              rf'\g<1>{x64_sha}\g<2>',
              content
          )

          with open(cask_path, "w") as f:
              f.write(content)

          print(f"Updated cask to v{version}")
          PYEOF

      - name: Verify changes
        run: cat Casks/oh-my-query.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/oh-my-query.rb
          git commit -m "Update oh-my-query to v${{ steps.payload.outputs.version }}"
          git push